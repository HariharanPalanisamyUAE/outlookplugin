<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Email Security Monitor</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 20px; 
            background-color: #1f2937; 
            color: #f3f4f6; 
            margin: 0; 
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #374151;
            padding-bottom: 15px;
        }
        .header h3 {
            color: #60a5fa;
            margin: 0 0 5px 0;
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px; 
            font-weight: 600;
            text-align: center;
            border: 2px solid;
        }
        .status.safe { 
            background-color: #065f46; 
            border-color: #10b981; 
            color: #d1fae5; 
        }
        .status.spam { 
            background-color: #7c2d12; 
            border-color: #f59e0b; 
            color: #fef3c7; 
        }
        .status.phishing { 
            background-color: #7f1d1d; 
            border-color: #ef4444; 
            color: #fecaca; 
        }
        .status.loading {
            background-color: #374151;
            border-color: #6b7280;
            color: #d1d5db;
        }
        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s ease;
            font-size: 14px;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn-delete { 
            background-color: #dc2626; 
            color: white; 
        }
        .btn-delete:hover { 
            background-color: #b91c1c; 
        }
        .btn-junk { 
            background-color: #2563eb; 
            color: white; 
        }
        .btn-junk:hover { 
            background-color: #1d4ed8; 
        }
        .btn-report { 
            background-color: #f59e0b; 
            color: white; 
        }
        .btn-report:hover { 
            background-color: #d97706; 
        }
        .details {
            background-color: #374151;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 12px;
        }
        .details label {
            color: #9ca3af;
            display: block;
            margin-bottom: 5px;
        }
        .details .value {
            color: #f3f4f6;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="header">
        <h3>üõ°Ô∏è Email Security Analysis</h3>
        <p style="margin: 0; color: #9ca3af; font-size: 14px;">Advanced threat detection</p>
    </div>
    
    <div id="analysis-result">
        <div class="status loading">
            <i>üîç Analyzing email...</i>
        </div>
    </div>
    
    <div id="email-details" style="display: none;">
        <div class="details">
            <label>Subject:</label>
            <div class="value" id="email-subject">-</div>
            
            <label style="margin-top: 10px;">Sender:</label>
            <div class="value" id="email-sender">-</div>
            
            <label style="margin-top: 10px;">Confidence Score:</label>
            <div class="value" id="confidence-score">-</div>
        </div>
    </div>
    
    <div id="action-buttons" class="actions" style="display: none;">
        <button class="btn-delete" onclick="deleteEmail()">
            üóëÔ∏è Delete Email
        </button>
        <button class="btn-junk" onclick="moveToJunk()">
            üìß Move to Junk
        </button>
        <button class="btn-report" onclick="reportThreat()">
            ‚ö†Ô∏è Report Threat
        </button>
    </div>

    <script>
        let currentAnalysis = null;

        Office.onReady((info) => {
            if (info.host === Office.HostType.Outlook) {
                analyzeCurrentEmail();
            }
        });

        async function analyzeCurrentEmail() {
            try {
                // Get email data from Outlook
                const emailBody = await getEmailBody();
                const subject = Office.context.mailbox.item.subject;
                const sender = Office.context.mailbox.item.sender ? Office.context.mailbox.item.sender.emailAddress : 'Unknown';
                
                // Get CC and BCC if available
                let cc = '';
                let bcc = '';
                
                if (Office.context.mailbox.item.cc && Office.context.mailbox.item.cc.length > 0) {
                    cc = Office.context.mailbox.item.cc.map(recipient => recipient.emailAddress).join(', ');
                }
                
                // Show email details
                document.getElementById('email-subject').textContent = subject || 'No Subject';
                document.getElementById('email-sender').textContent = sender;
                document.getElementById('email-details').style.display = 'block';
                
                // Analyze email using FastAPI backend
                await analyzeEmail(emailBody, subject, sender, cc, bcc);
                
            } catch (error) {
                displayError('Failed to analyze email: ' + error.message);
            }
        }

        function getEmailBody() {
            return new Promise((resolve, reject) => {
                Office.context.mailbox.item.body.getAsync("text", (result) => {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        resolve(result.value);
                    } else {
                        reject(new Error('Failed to get email body'));
                    }
                });
            });
        }

        async function analyzeEmail(body, subject, sender, cc, bcc) {
            try {
                const response = await fetch('http://localhost:5000/api/analyze-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        body: body || '',
                        subject: subject || '',
                        sender: sender || '',
                        cc: cc || '',
                        bcc: bcc || '',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Analysis failed');
                }
                
                const result = await response.json();
                currentAnalysis = result;
                displayAnalysisResult(result);
                
            } catch (error) {
                displayError('Error analyzing email: ' + error.message);
            }
        }

        function displayAnalysisResult(result) {
            const resultDiv = document.getElementById('analysis-result');
            const actionsDiv = document.getElementById('action-buttons');
            const confidenceScore = document.getElementById('confidence-score');
            
            const confidencePercent = (result.confidence * 100).toFixed(1);
            confidenceScore.textContent = `${confidencePercent}%`;
            
            let alertClass = 'safe';
            let message = '‚úÖ This email appears to be safe.';
            let showActions = false;
            
            const confidenceThreshold = 0.7; // 70% confidence threshold
            
            if (result.prediction === 'spam' && result.confidence >= confidenceThreshold) {
                alertClass = 'spam';
                message = `‚ö†Ô∏è SPAM DETECTED`;
                showActions = true;
            } else if (result.prediction === 'phishing' && result.confidence >= confidenceThreshold) {
                alertClass = 'phishing';
                message = `üö® PHISHING DETECTED`;
                showActions = true;
            } else if ((result.prediction === 'spam' || result.prediction === 'phishing') && result.confidence < confidenceThreshold) {
                alertClass = 'spam';
                message = `ü§î Suspicious Email (${result.prediction})`;
                showActions = false; // Don't show actions for low confidence
            }
            
            resultDiv.innerHTML = `<div class="status ${alertClass}">${message}</div>`;
            actionsDiv.style.display = showActions ? 'flex' : 'none';
        }

        function displayError(message) {
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = `<div class="status phishing">‚ùå ${message}</div>`;
        }

        async function deleteEmail() {
            if (!confirm('Are you sure you want to delete this email?')) {
                return;
            }
            
            try {
                await new Promise((resolve, reject) => {
                    Office.context.mailbox.item.deleteAsync((result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            resolve();
                        } else {
                            reject(new Error('Failed to delete email'));
                        }
                    });
                });
                
                await logAction('deleted');
                displaySuccess('Email deleted successfully');
                
            } catch (error) {
                displayError('Failed to delete email: ' + error.message);
            }
        }

        async function moveToJunk() {
            try {
                await new Promise((resolve, reject) => {
                    Office.context.mailbox.item.move('junkemail', (result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            resolve();
                        } else {
                            reject(new Error('Failed to move email'));
                        }
                    });
                });
                
                await logAction('moved_to_junk');
                displaySuccess('Email moved to junk folder');
                
            } catch (error) {
                displayError('Failed to move email to junk: ' + error.message);
            }
        }

        async function reportThreat() {
            try {
                const response = await fetch('http://localhost:5000/api/report-threat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        sender: Office.context.mailbox.item.sender?.emailAddress || 'Unknown',
                        subject: Office.context.mailbox.item.subject || '',
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to report threat');
                }

                await logAction('reported_as_threat');
                displaySuccess('Threat reported to SOC team!');
                
            } catch (error) {
                displayError('Failed to report threat: ' + error.message);
            }
        }

        async function logAction(action) {
            try {
                const response = await fetch('http://localhost:5000/api/log-action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action
                    })
                });

                if (!response.ok) {
                    console.warn('Failed to log action:', action);
                }
            } catch (error) {
                console.warn('Failed to log action:', error);
            }
        }

        function displaySuccess(message) {
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = `<div class="status safe">‚úÖ ${message}</div>`;
            // Hide action buttons after successful action
            document.getElementById('action-buttons').style.display = 'none';
        }
    </script>
</body>
</html>
